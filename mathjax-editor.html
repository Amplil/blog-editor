<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>ブログエディタ</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
</head>

<body>
<div class="row">
    <div class="col-5 m-1">
        <!-- ここに入力-->
        <textarea name="article" id="editor_area" cols="30" rows="30" class="form-control"></textarea>
    </div>
    <div class="col-6 m-1 border">
        <!-- ここに出力される -->
        <iframe src="blog-view.php" id="preview" width="100%" height="100%"></iframe>
    </div>
</div>

<script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>

<script>
    // マークダウンをプレビュー画面に表示する
    $(function () {
        let load_num=0;
        let previous_html="";
        let event_flag=0;
        marked.setOptions({
            // code要素にdefaultで付くlangage-を削除
            langPrefix: '',
            // highlightjsを使用したハイライト処理を追加
            highlight: function (code, lang) {
                return hljs.highlightAuto(code, [lang]).value
            }
        });
        $('#editor_area').keyup(function () {
            //let html = marked($(this).val());
            if( event_flag===0){
                event_flag=1;
                window.setTimeout(function(){
                    let html = marked($('#editor_area').val());
                    event_flag=0;
                    if(previous_html!=html){
                        previous_html=html;
                        load_num++;
                        console.log("load_num:",load_num);
                        $.post({
                            url: 'blog-text-save.php',
                            data:{"blog_text": html},
                            dataType: 'json' //必須。json形式で返すように設定
                        }).done(function(data){
                            document.getElementById("preview").contentWindow.location.reload();
                        }).fail(function(XMLHttpRequest, textStatus, errorThrown){
                            alert(errorThrown);
                        })
                    }
                }, 1000);
            }
        });
        /*
        $(window).keydown(function(e){
            if(event.shiftKey){
                if(e.keyCode === 13){
                    $.post({
                        url: 'price_comparison_ajax.php',
                        data:{"blog-text": html},
                        dataType: 'json' //必須。json形式で返すように設定
                    }).done(function(data){
                }
            }
        });
        */
    });

</script>

</body>
</html>